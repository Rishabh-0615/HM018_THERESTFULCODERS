import { useEffect, useState } from "react";
import { theme } from "../theme";
import { motion } from "framer-motion";

const getTokenFromCookies = () => {
  return document.cookie
    .split("; ")
    .find(row => row.startsWith("token="))
    ?.split("=")[1];
};

const steps = [
  "placed",
  "approved",
  "packed",
  "shipped",
  "delivered"
];

export default function OrdersDhruv() {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const token = getTokenFromCookies();

    fetch("http://localhost:5005/api/orders/my-orders", {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
      .then(res => res.json())
      .then(data => {
        setOrders(data);
        setLoading(false);
      })
      .catch(() => setLoading(false));
  }, []);

  if (loading) {
    return <p style={{ padding: 24 }}>Loading orders...</p>;
  }

  if (orders.length === 0) {
    return <p style={{ padding: 24 }}>No orders found.</p>;
  }

  return (
    <div style={{ padding: 24 }}>
      <h2 style={{ marginBottom: 20 }}>My Orders</h2>

      {orders.map(order => (
        <motion.div
          key={order._id}
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          style={{
            background: theme.surface,
            border: `1px solid ${theme.border}`,
            borderRadius: 10,
            padding: 16,
            marginBottom: 16
          }}
        >
          <h4>Order ID: {order._id.slice(-6)}</h4>
          <p>Total: ₹{order.totalAmount}</p>

          {/* MEDICINES */}
          <ul>
            {order.medicines.map(m => (
              <li key={m._id}>
                {m.medicineId?.name} × {m.quantity}
              </li>
            ))}
          </ul>

          {/* TIMELINE */}
          <div style={{ marginTop: 12 }}>
            <OrderTimeline
              orderStatus={order.orderStatus}
              deliveryStatus={order.deliveryStatus}
            />
          </div>
        </motion.div>
      ))}
    </div>
  );
}
